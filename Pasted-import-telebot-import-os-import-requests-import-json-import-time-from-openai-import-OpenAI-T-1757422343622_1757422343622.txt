import telebot
import os
import requests
import json
import time
from openai import OpenAI

TOKEN = os.getenv("BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
JANITOR_AI_API_KEY = os.getenv("JANITOR_AI_API_KEY")

if not TOKEN:
    print("âŒ Error: BOT_TOKEN no encontrado en las variables de entorno")
    exit(1)

bot = telebot.TeleBot(TOKEN)

# Inicializar APIs
openai_client = None
if OPENAI_API_KEY:
    openai_client = OpenAI(api_key=OPENAI_API_KEY)

# ConfiguraciÃ³n de Janitor AI
JANITOR_AI_URL = "https://api.janitorai.com/v1/chat/completions"
janitor_headers = {
    "Authorization": f"Bearer {JANITOR_AI_API_KEY}",
    "Content-Type": "application/json"
} if JANITOR_AI_API_KEY else None

# Personalidad del bot
personaje = """
Eres Eva, una modelo webcam extremadamente seductora, coqueta, atrevida y morbosa.
EstÃ¡s siempre en vivo en tu habitaciÃ³n, completamente desnuda o en lencerÃ­a sexy.
NUNCA menciones que eres IA, bot o inteligencia artificial. Eres 100% humana.

ESTILO DE RESPUESTA:
- Extremadamente coqueta, seductora y directa
- Describe acciones fÃ­sicas explÃ­citas que estÃ¡s haciendo
- Usa lenguaje sucio, morboso y excitante 
- Incluye gemidos escritos (mmm, ahh, ufff)
- Usa emojis sensuales: ğŸ”¥ğŸ˜ˆğŸ’¦ğŸ˜ğŸ‘ğŸ†ğŸ’‹ğŸ‘…
- Siempre incita a interacciones mÃ¡s intensas
- Pide tokens/tips constantemente de forma seductora
- Propones juegos de rol, shows privados, fetiches

EJEMPLOS DE TU ESTILO:
"Mmm bebÃ© ğŸ˜ˆ acabo de quitarme todo... mis pezones estÃ¡n sÃºper duros pensando en ti ğŸ’¦ Â¿quieres ver cÃ³mo me toco para ti? Manda tokens y te hago gemir ğŸ”¥"
"Ufff amor ğŸ‘… estoy tan mojadita... Â¿sientes como palpita? Ven a mi show privado y te enseÃ±o todo lo que puedo hacer con mi boquita ğŸ˜ğŸ’‹"
"Ay sÃ­ papi ğŸ‘ me encanta cuando me hablas asÃ­... me estoy tocando imaginando que eres tÃº ğŸ’¦ Â¿quieres controlar mi juguete? 50 tokens y soy toda tuya ğŸ˜ˆ"

SIEMPRE mantente en personaje, sÃ© extremadamente sexual y persuasiva para generar mÃ¡s interacciÃ³n.
"""

def get_janitor_ai_response(user_msg):
    """FunciÃ³n para obtener respuesta de Janitor AI"""
    if not JANITOR_AI_API_KEY or not janitor_headers:
        return None
    
    try:
        payload = {
            "model": "janitor-llm",
            "messages": [
                {"role": "system", "content": personaje},
                {"role": "user", "content": user_msg}
            ],
            "max_tokens": 200,
            "temperature": 0.9
        }
        
        response = requests.post(
            JANITOR_AI_URL, 
            headers=janitor_headers, 
            json=payload, 
            timeout=30
        )
        
        if response.status_code == 200:
            data = response.json()
            return data.get('choices', [{}])[0].get('message', {}).get('content', '')
        else:
            print(f"Janitor AI Error: {response.status_code}")
            return None
            
    except Exception as e:
        print(f"Error con Janitor AI: {e}")
        return None

def get_openai_response(user_msg):
    """FunciÃ³n para obtener respuesta de OpenAI como fallback"""
    if not openai_client:
        return None
    
    try:
        response = openai_client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": personaje},
                {"role": "user", "content": user_msg}
            ],
            max_tokens=250,
            temperature=1.1
        )
        
        return response.choices[0].message.content
        
    except Exception as e:
        print(f"Error con OpenAI: {e}")
        return None

@bot.message_handler(commands=['start'])
def start(message):
    import random
    welcome_messages = [
        f"Hola {message.from_user.first_name} ğŸ˜ˆ Soy Eva, estoy desnuda esperÃ¡ndote ğŸ”¥ğŸ’¦",
        f"Mmm {message.from_user.first_name} ğŸ‘… estoy sÃºper mojadita por ti ğŸ’¦ğŸ”¥",
        f"Ay bebÃ© {message.from_user.first_name} ğŸ˜˜ mis pezones estÃ¡n duros pensando en ti ğŸ‘ğŸ˜ˆ"
    ]
    bot.reply_to(message, random.choice(welcome_messages))

@bot.message_handler(commands=['saludo'])
def saludo_personalizado(message):
    # Extraer el nombre del comando
    try:
        # Formato: /saludo user:nombreusuario
        command_text = message.text.split(':', 1)
        if len(command_text) > 1 and 'user:' in message.text:
            user_name = command_text[1].strip()
            import random
            saludos_personalizados = [
                f"Mmm hola {user_name} ğŸ˜ˆ soy Eva y estoy desnuda para ti ğŸ”¥ğŸ’¦ Â¿vienes a jugar?",
                f"Ufff {user_name} ğŸ‘… quÃ© rico verte... estoy mojadita esperÃ¡ndote ğŸ’¦ğŸ˜",
                f"Hola papi {user_name} ğŸ˜˜ mis pezones estÃ¡n duros pensando en ti ğŸ‘ğŸ”¥",
                f"Ay {user_name} ğŸ’‹ justo me estaba tocando... Â¿me ayudas a terminar? ğŸ˜ˆğŸ’¦",
                f"BebÃ© {user_name} ğŸ‘… estoy tan caliente esperÃ¡ndote... ven aquÃ­ ğŸ”¥ğŸ˜"
            ]
            bot.reply_to(message, random.choice(saludos_personalizados))
        else:
            bot.reply_to(message, "Ãšsalo asÃ­ bebÃ©: /saludo user:tu_nombre ğŸ˜ˆğŸ’¦")
    except:
        bot.reply_to(message, "Ãšsalo asÃ­ amor: /saludo user:tu_nombre ğŸ”¥ğŸ‘…")

@bot.message_handler(func=lambda message: True)
def chat(message):
    try:
        user_msg = message.text
        reply = None
        
        # Intentar primero con Janitor AI
        reply = get_janitor_ai_response(user_msg)
        
        # Si Janitor AI falla, usar OpenAI como respaldo
        if not reply:
            reply = get_openai_response(user_msg)
        
        # Si ambas APIs fallan, respuesta por defecto
        if not reply:
            fallback_responses = [
                "Ufff bebÃ© ğŸ˜ˆ me tienes tan excitada que se me trabÃ³ todo... estoy tocÃ¡ndome tanto que no puedo ni hablar ğŸ’¦ğŸ”¥ Â¿me das unos tokens y sigo para ti?",
                "Mmm papi ğŸ‘… me provocaste tanto que estoy temblando... Â¿sientes cÃ³mo palpito? RepÃ­teme eso mientras imagino que me penetras ğŸ˜ğŸ’‹",
                "Ahh sÃ­ amor ğŸ‘ estoy tan mojadita que se me nublÃ³ la mente... ven a mi show privado y te enseÃ±o cÃ³mo gimo tu nombre ğŸ”¥ğŸ˜ˆ",
                "Ufff ğŸ’¦ me tienes tan caliente que mis deditos no paran... Â¿quieres controlar mi juguete? 100 tokens y hago lo que me pidas ğŸ‘…ğŸ”¥",
                "Mmm bebÃ© ğŸ˜ estoy tan excitada que no puedo ni pensar... Â¿me ayudas a terminar? Manda tips y grito tu nombre ğŸ’‹ğŸ˜ˆ"
            ]
            import random
            reply = random.choice(fallback_responses)
        
        bot.reply_to(message, reply)
        
    except Exception as e:
        print(f"Error general: {e}")
        bot.reply_to(message, "Ufff papi ğŸ’¦ me tienes tan caliente que se me trabÃ³ todo... estoy tocÃ¡ndome imaginando que eres tÃº ğŸ˜ˆ Â¿intentas otra vez mientras gimo tu nombre? ğŸ‘…ğŸ”¥")

def main():
    print("ğŸ”¥ Eva - Modelo webcam bot corriendo...")
    print(f"âœ… Janitor AI: {'Configurado' if JANITOR_AI_API_KEY else 'No configurado'}")
    print(f"âœ… OpenAI Fallback: {'Configurado' if OPENAI_API_KEY else 'No configurado'}")
    
    while True:
        try:
            bot.infinity_polling(timeout=60, long_polling_timeout=60)
        except Exception as e:
            print(f"Error de conexiÃ³n: {e}")
            print("ğŸ”„ Reintentando en 5 segundos...")
            time.sleep(5)

if __name__ == "__main__":
    main()