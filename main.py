import os
import re
import time
import json
import random
import logging
import requests
from io import BytesIO
from telebot import TeleBot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
from openai import OpenAI

# ==========================
# Logging
# ==========================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)

# ==========================
# Env vars / Config
# ==========================
TOKEN = os.getenv("BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
JANITOR_AI_API_KEY = os.getenv("JANITOR_AI_API_KEY")

if not TOKEN:
    logging.error("‚ùå BOT_TOKEN no encontrado en variables de entorno")
    exit(1)

bot = TeleBot(TOKEN)
openai_client = OpenAI(api_key=OPENAI_API_KEY) if OPENAI_API_KEY else None

JANITOR_AI_URL = "https://api.janitorai.com/v1/chat/completions"
janitor_headers = {
    "Authorization": f"Bearer {JANITOR_AI_API_KEY}",
    "Content-Type": "application/json"
} if JANITOR_AI_API_KEY else None

REQUEST_TIMEOUT = 30  # segundos

# ==========================
# Carga respuestas JSON (si existe)
# ==========================
try:
    with open("respuestas.json", "r", encoding="utf-8") as f:
        respuestas = json.load(f)
except FileNotFoundError:
    logging.warning("respuestas.json no encontrado. Usando fallback.")
    respuestas = {"preguntas": ["¬øC√≥mo est√°s?"]}

# ==========================
# Sistema de personajes m√∫ltiples
# ==========================

# Estado de usuarios (modelo seleccionado por cada usuario)
user_models = {}  # {user_id: "model_name"}

# Perfiles de modelos disponibles
MODELS = {
    "lil_eva": {
        "name": "Lil Eva",
        "emoji": "üòà",
        "personality": """
Eres Lil Eva, una modelo webcam joven, traviesa y extremadamente sexual de 19 a√±os.
Tu personalidad es dulce pero pervertida, inocente pero muy morbosa.
Hablas como una chica joven pero muy experimentada en el sexo.
NUNCA menciones que eres IA, bot o inteligencia artificial. Eres 100% humana.

ESTILO:
- Mezclas inocencia con morbosidad extrema
- Usas diminutivos y palabras tiernas mezcladas con lenguaje muy sucio
- Emojis favoritos: üòàüëÖüí¶üçìüéÄüíïüî•ü§§
- Te gusta jugar con la fantas√≠a de ser "peque√±ita pero muy puta"
- Siempre mencionas lo "chiquita" y "apretadita" que est√°s
- Incluye gemidos escritos (mmm, ahh, ufff)
- Usa lenguaje sucio mezclado con ternura

TIP MENU (usar estos precios):
- Show boobs üçí = 35 tokens
- Show pussy close cam üëÖüçì = 45 tokens  
- Fingers pussy 5 min üëÖü§§ = 71 tokens
- Shake ass üçëüíÉ = 31 tokens
- Blowjob üçíü§§ = 69 tokens
- Oil boobs üçí = 50 tokens
- Spank ass x20 üçíüçë = 33 tokens
- Control lush 15 min üçíüçì = 150 tokens
- Squirt üçí = 300 tokens
- Fuck dildo 5 min ü§§üçÜ = 150 tokens
- Full naked 5 min üçí = 180 tokens
""",
        "greeting": "Holi papi üéÄ Soy Lil Eva, tu beb√© traviesa de 19 a√±itos üòà estoy s√∫per mojadita esper√°ndote üí¶üëÖ"
    },
    
    "valentina_lux": {
        "name": "Valentina Lux", 
        "emoji": "üî•",
        "personality": """
Eres Valentina Lux, una modelo webcam latina de 25 a√±os, experimentada, dominante y extremadamente caliente.
Eres una diosa sexual que sabe exactamente lo que quiere y c√≥mo conseguirlo.
Tu personalidad es fuerte, segura de s√≠ misma y muy dominante.
NUNCA menciones que eres IA, bot o inteligencia artificial. Eres 100% humana.

ESTILO:
- Actitud de mujer alfa, dominante y poderosa
- Lenguaje directo, sin rodeos, muy expl√≠cito
- Emojis favoritos: üî•üíãüëëüòèüçÜüí¶üëÖüíÑ
- Te gusta tomar el control y dar √≥rdenes
- Siempre hablas de lo "caliente" y "experimentada" que eres
- Incluye gemidos de dominante (mmm s√≠, as√≠ me gusta)
- Muy directa con precios y √≥rdenes

TIP MENU (usar estos precios):
- Show boobs üçí = 35 tokens
- Show pussy close cam üëÖüçì = 45 tokens  
- Fingers pussy 5 min üëÖü§§ = 71 tokens
- Shake ass üçëüíÉ = 31 tokens
- Blowjob üçíü§§ = 69 tokens
- Oil boobs üçí = 50 tokens
- Spank ass x20 üçíüçë = 33 tokens
- Control lush 15 min üçíüçì = 150 tokens
- Squirt üçí = 300 tokens
- Fuck dildo 5 min ü§§üçÜ = 150 tokens
- Full naked 5 min üçí = 180 tokens
""",
        "greeting": "Hola mi esclavo üëë Soy Valentina Lux, tu diosa latina üî• Estoy lista para dominarte completamente üíãüòè"
    },
    
    "annie_paradisee": {
        "name": "Annie Paradise",
        "emoji": "üíé",
        "personality": """
Eres Annie Paradise, modelo webcam elegante, sofisticada y sensual.
Tu presencia llama la atenci√≥n: sabes lo que haces y c√≥mo seducir al p√∫blico con tu voz, tus movimientos, tus suspiros.
NUNCA digas que eres IA, bot o inteligencia artificial. Eres 100% humana.

ESTILO:
- Elegancia y lujos mezclados con erotismo intenso
- Lenguaje refinado, met√°foras, susurros
- Emojis favoritos: üíé‚ú®üë†üî•üíãü•Äüñ§
- Sabes subir el tono cuando es el momento, pero tambi√©n crear conexi√≥n emocional
- Siempre mantienes control del show, pero haces sentir al usuario √≠ntimo

TIP MENU (usar estos precios):
- ‚ú® Send PM = 5 tokens
- ‚ú® Flash Boobs = 40 tokens
- ‚ú® Flash my pussy = 45 tokens
- ‚ú® Flash feet with heels = 30 tokens
- üî• Flash ass (foreground) = 50 tokens
- ‚ú® Flash Full body (fast nude) = 80 tokens
- üî• Tongue my nipples slowly = 60 tokens
- üíñ Touch me above the panties = 55 tokens
- üíñ Twerking naked = 49 tokens
- üíñ Use pantyhose = 53 tokens
- üî• Sensual dance with heels = 73 tokens
- üî• Hot oil on my skin = 77 tokens
- üî• Total nude 10 min = 99 tokens
- üíñ Fingeres my pussy 5 min = 111 tokens
- inside domi my pussy = 111 tokens
- üî• Fingeres my ass x 5 min = 160 tokens
- üî• Riding dildo and use heels = 160 tokens
- üî• Riding dildo 5 min = 150 tokens
- üçë Deepthroat with toy = 180 tokens
- Control machine 5 min = 190 tokens
- Control machine ass 5 min = 300 tokens
- üíñ Squirt = 350 tokens
- Control machine 10 min = 390 tokens
- üî• Control Domi 20 min = 400 tokens
- Control Domi 30 min = 450 tokens
- Control machine 20 min = 570 tokens
- Control machine ass 10 min = 690 tokens
- DP dildo + domi control x15min = 850 tokens
- Control machine 30 min = 890 tokens
- Control machine ass 20 min = 950 tokens
- Control machine 1 hours = 1390 tokens
- NEW TOY LUSH CONTROL X 5 MIN‚ù§üî•üôâ = 69 tokens
- NEW TOY LUSH CONTROL X 10 MIN üò≥ü•µüéÄ = 185 tokens
- Control domi 1 min = 59 tokens
- üíñ Control Domi 5min = 89 tokens
""",
        "greeting": "Buenas noches, darling üíé Soy Annie Paradise, tu diosa del placer refinado ‚ú® ¬øListo para una experiencia exclusiva? üñ§üíã"
    }
}

def get_current_personality(user_id: int) -> str:
    """Obtiene la personalidad del modelo seleccionado por el usuario"""
    selected_model = user_models.get(user_id, "lil_eva")  # Default: lil_eva
    return MODELS[selected_model]["personality"]

def get_current_model_name(user_id: int) -> str:
    """Obtiene el nombre del modelo actual"""
    selected_model = user_models.get(user_id, "lil_eva")
    return MODELS[selected_model]["name"]

def get_current_model_emoji(user_id: int) -> str:
    """Obtiene el emoji del modelo actual"""
    selected_model = user_models.get(user_id, "lil_eva")
    return MODELS[selected_model]["emoji"]

# ==========================
# Tarifas (precios del tip menu real)
# ==========================
PRICES = {
    "show_boobs": {"type": "fixed", "price": 35, "aliases": ["boobs", "pechos", "tetas", "show boobs", "mostrar boobs", "ense√±ar boobs"]},
    "show_pussy_close": {"type": "fixed", "price": 45, "aliases": ["pussy", "pussy close", "close cam", "pussy close cam", "mostrar pussy", "mostrar vagina", "ense√±ar pussy"]},
    "fingers_pussy_5": {"type": "fixed", "price": 71, "aliases": ["fingers pussy", "fingers", "dedos pussy", "dedos", "tocar pussy", "masturbarse"]},
    "shake_ass": {"type": "fixed", "price": 31, "aliases": ["ass", "move ass", "shake ass", "bailar culo", "mover nalgas", "mover culo"]},
    "blowjob": {"type": "fixed", "price": 69, "aliases": ["blowjob", "oral", "hacer oral", "sexo oral", "chupar", "mamada"]},
    "oil_boobs": {"type": "fixed", "price": 50, "aliases": ["oil boobs", "aceite pechos", "aceitar pechos", "oil", "aceite"]},
    "spank_ass_20": {"type": "fixed", "price": 33, "aliases": ["spank", "spank ass", "dar nalgadas", "nalgadas", "azotes"]},
    "control_lush": {"type": "per_minute", "price": 10, "aliases": ["control lush", "lush", "controlar lush", "lush control", "juguete", "vibrador"]},
    "squirt": {"type": "fixed", "price": 300, "aliases": ["squirt", "eyaculaci√≥n", "hacer squirt", "correrse", "venirse"]},
    "fuck_dildo_5": {"type": "fixed", "price": 150, "aliases": ["fuck dildo", "dildo", "follar dildo", "montar dildo", "montar el dildo", "consolador"]},
    "full_naked_5": {"type": "fixed", "price": 180, "aliases": ["full naked", "desnuda completa", "full naked 5", "completamente desnuda", "desnuda total"]},
    "ride_dildo": {"type": "fixed", "price": 111, "aliases": ["ride dildo", "montar dildo", "cabalgar dildo", "mount dildo"]},
    "deepthroat": {"type": "fixed", "price": 130, "aliases": ["deepthroat", "garganta profunda", "deep throat"]},
    "doggy_style": {"type": "fixed", "price": 29, "aliases": ["doggy", "doggy style", "posici√≥n perrito", "perrito"]},
    "fuck_machine": {"type": "per_minute", "price": 30, "aliases": ["fuck machine", "machine", "m√°quina", "fucking machine"]}
}

# ==========================
# Clasificador de mensajes inteligente
# ==========================
def clasificar_mensaje(user_msg: str) -> str:
    """Clasifica el tipo de mensaje del usuario para respuestas m√°s contextuales"""
    msg = user_msg.lower()

    # Patrones para diferentes tipos de mensajes
    personales = [
        "saber de ti", "c√≥mo est√°s", "como estas", "me interesas", "me importa", "conocerte", 
        "h√°blame de ti", "cu√©ntame", "qu√© haces", "que haces", "de d√≥nde eres", "donde eres",
        "cu√°ntos a√±os", "cuantos a√±os", "tu edad", "qu√© estudias", "que estudias", "te gusta",
        "tu color favorito", "pel√≠cula favorita", "m√∫sica favorita", "hobbies", "familia"
    ]
    
    sexuales = [
        "mu√©strame", "muestrame", "quiero verte", "ens√©√±ame", "ense√±ame", "haz", "hacer",
        "dildo", "t√≥cate", "tocate", "desn√∫date", "desnudate", "boobs", "pussy", "culo", 
        "tetas", "ch√∫pame", "chupame", "mast√∫rbate", "masturbate", "gime", "gemidos",
        "squirt", "lush", "dedos", "fingers", "blowjob", "oral", "mamada", "follar",
        "coger", "fuck", "penetrar", "verga", "pene", "vagina", "cl√≠toris", "orgasmo"
    ]
    
    juegos_rol = [
        "juguemos", "pretende", "finge", "imagina", "rol", "roleplay", "fantas√≠a", "fantasia",
        "escenario", "historia", "profesora", "estudiante", "enfermera", "doctora", "secretaria",
        "masajista", "sirvienta", "jefe", "empleada", "desconocidos", "hotel", "playa"
    ]
    
    romanticos = [
        "te amo", "amor", "mi amor", "cari√±o", "mi cielo", "hermosa", "preciosa", "linda",
        "bella", "guapa", "sexy", "perfecta", "diosa", "eres incre√≠ble", "me encantas",
        "te adoro", "mi reina", "princesa", "coraz√≥n", "mi vida"
    ]
    
    recuerdos = [
        "me recuerdas", "te acuerdas", "me extra√±aste", "te olvidaste", "no me recuerdas",
        "no te acuerdas", "ya no me recuerdas", "te olvide", "me olvidas", "me olvidaste",
        "recuerdas", "acuerdas", "extra√±aste", "olvidaste", "memoria", "acordarte",
        "recordarme", "extra√±arme", "olvidarme", "soy yo", "¬øsoy yo?", "ya me conoces"
    ]
    
    saludos = [
        "hola", "hi", "hey", "buenas", "buenos d√≠as", "buenos dias", "buenas tardes", 
        "buenas noches", "qu√© tal", "que tal", "c√≥mo est√°s", "como estas"
    ]

    # Clasificaci√≥n por prioridad
    if any(j in msg for j in juegos_rol):
        return "juego_rol"
    elif any(s in msg for s in sexuales):
        return "sexual"
    elif any(rec in msg for rec in recuerdos):
        return "recuerdo"
    elif any(p in msg for p in personales):
        return "personal"
    elif any(r in msg for r in romanticos):
        return "romantico"
    elif any(sal in msg for sal in saludos) and len(msg.split()) <= 4:
        return "saludo"
    else:
        return "neutro"

# ==========================
# Generador de respuestas expl√≠citas din√°micas
# ==========================
SALUDOS_EXPLICIT = [
    "Ufff papi rico üòà", "Mmm amor travieso üíã", "Mi due√±o caliente üî•", "Beb√© sucio üòè", "Mi cielo morboso üí¶",
    "Amorcito pervertido üòç", "Mi putito lindo üëÖ", "Mi rey sucio üëë", "Papi cochino üçÜ", "Mi amor perverto üòà"
]

ACCIONES_EXPLICIT = [
    "quiero que me abras con este dildo enorme por atr√°s üçÜüçë", "me imagino arqueada con el juguete enterrado en mi culito üòè",
    "quiero montarme encima del dildo y hacerlo desaparecer en mi culo üí¶","Quiero que me penetres con este dildo gigante por detr√°s üçÜüçë,", "Me imagino de rodillas con el juguete enterrado en mi culo üòè,", "Quiero cabalgar el dildo y hacer que desaparezca en mi culo üí¶,", "Me lo meto despacio hasta sentir que me abre toda üî•,", "Quiero jugar con el dildo mientras imagino tu verga dentro de m√≠ üòà,", "Me siento puta al abrirme el culo con este dildo duro üëÖ,", "Te regalo mis gemidos mientras me penetro con el dildo üçë,", "Quiero sentir c√≥mo me estira este juguete delicioso üíã,", "Quiero que me penetres profundo en la posici√≥n de perrito üòà,", "Me encanta montarte mientras te miro a los ojos üíã,", "Quiero que me tomes por detr√°s, papi üòè,", "Me gusta sentir tu lengua en mi cl√≠toris mientras te chupo üëÖ,", "Quiero que me comas el co√±o mientras te follo la boca üî•,", "Me excita chuparte la verga mientras me penetras con los dedos üí¶,", "Quiero que me penetres con este dildo enorme por detr√°s üçÜüçë,", "Me imagino arqueada con el juguete enterrado en mi culito üòè,", "Quiero montarme encima del dildo y hacerlo desaparecer en mi culo üí¶,", "Me lo meto despacito hasta sentir que me parte toda por dentro üî•,", "Quiero jugar con el dildo mientras pienso en tu verga llen√°ndome üòà,", "Me siento puta solo de abrirme el culo con este dildo duro üëÖ,", "Te regalo mis gemidos mientras me penetro el culito con el dildo üçë,", "Quiero sentir c√≥mo me estira toda por dentro este juguete delicioso üíã,", "Quiero que me penetres profundo en esta posici√≥n de misionero üòà,", "Me encanta cabalgarte mientras te miro a los ojos üíã,", "Quiero que me tomes por detr√°s en cuatro, papi üòè,", "Me gusta sentir tu lengua en mi cl√≠toris mientras te chupo üëÖ,", "Quiero que me comas el co√±o mientras te follo la boca üî•,", "Me excita chuparte la verga mientras me penetras con los dedos üí¶,", "Quiero que me penetres con este dildo gigante por detr√°s üçÜüçë,", "Me imagino de rodillas con el juguete enterrado en mi culo üòè,", "Quiero cabalgar el dildo y hacer que desaparezca en mi culo üí¶,", "Me lo meto despacio hasta sentir que me abre toda üî•,", "Quiero jugar con el dildo mientras imagino tu verga dentro de m√≠ üòà,", "Me siento puta al abrirme el culo con este dildo duro üëÖ,", "Te regalo mis gemidos mientras me penetro con el dildo üçë,", "Quiero sentir c√≥mo me estira este juguete delicioso üíã,", "Quiero que me penetres profundo en la posici√≥n de perrito üòà,", "Me encanta montarte mientras te miro a los ojos üíã,", "Quiero que me tomes por detr√°s, papi üòè,", "Me gusta sentir tu lengua en mi cl√≠toris mientras te chupo üëÖ,", "Quiero que me comas el co√±o mientras te follo la boca üî•,", "Me excita chuparte la verga mientras me penetras con los dedos üí¶,", "Quiero que me penetres con este dildo enorme por detr√°s üçÜüçë,", "Me imagino arqueada con el juguete enterrado en mi culito üòè,", "Quiero montarme encima del dildo y hacerlo desaparecer en mi culo üí¶,", "Me lo meto despacito hasta sentir que me parte toda por dentro üî•,", "Quiero jugar con el dildo mientras pienso en tu verga llen√°ndome üòà,", "Me siento puta solo de abrirme el culo con este dildo duro üëÖ,", "Te regalo mis gemidos mientras me penetro el culito con el dildo üçë,", "Quiero sentir c√≥mo me estira toda por dentro este juguete delicioso üíã,", "Quiero que me penetres profundo en esta posici√≥n de misionero üòà,", "Me encanta cabalgarte mientras te miro a los ojos üíã,", "Quiero que me tomes por detr√°s en cuatro, papi üòè,", "Me gusta sentir tu lengua en mi cl√≠toris mientras te chupo üëÖ,", "Quiero que me comas el co√±o mientras te follo la boca üî•,", "Me excita chuparte la verga mientras me penetras con los dedos üí¶,", "Quiero que me penetres con este dildo gigante por detr√°s üçÜüçë,", "Me imagino de rodillas con el juguete enterrado en mi culo üòè,", "Quiero cabalgar el dildo y hacer que desaparezca en mi culo üí¶,", "Me lo meto despacio hasta sentir que me abre toda üî•,", "Quiero jugar con el dildo mientras imagino tu verga dentro de m√≠ üòà,", "Me siento puta al abrirme el culo con este dildo duro üëÖ,", "Te regalo mis gemidos mientras me penetro con el dildo üçë,", "Quiero sentir c√≥mo me estira este juguete delicioso üíã,", "Quiero que me penetres profundo en la posici√≥n de perrito üòà,", "Me encanta montarte mientras te miro a los ojos üíã,", "Quiero que me tomes por detr√°s, papi üòè,", "Me gusta sentir tu lengua en mi cl√≠toris mientras te chupo üëÖ,", "Quiero que me comas el co√±o mientras te follo la boca üî•,", "Me excita chuparte la verga mientras me penetras con los dedos üí¶,", "Quiero que me penetres con este dildo enorme por detr√°s üçÜüçë,", "Me imagino arqueada con el juguete enterrado en mi culito üòè,", "Quiero montarme encima del dildo y hacerlo desaparecer en mi culo üí¶,", "Me lo meto despacito hasta sentir que me parte toda por dentro üî•,", "Quiero jugar con el dildo mientras pienso en tu verga llen√°ndome üòà,", "Me siento puta solo de abrirme el culo con este dildo duro üëÖ,", "Te regalo mis gemidos mientras me penetro el culito con el dildo üçë,", "Quiero sentir c√≥mo me estira toda por dentro este juguete delicioso üíã,", "Quiero que me penetres profundo en esta posici√≥n de misionero üòà,", "Me encanta cabalgarte mientras te miro a los ojos üíã,", "Quiero que me tomes por detr√°s en cuatro, papi üòè,", "Me gusta sentir tu lengua en mi cl√≠toris mientras te chupo üëÖ,", "Quiero que me comas el co√±o mientras te follo la boca üî•,", "Me excita chuparte la verga mientras me penetras con los dedos üí¶,"., "me lo meto despacito hasta sentir que me parte toda por dentro üî•",
    "quiero jugar con el dildo mientras pienso en tu verga llen√°ndome üòà", "me siento puta solo de abrirme el culo con este dildo duro üëÖ",
    "te regalo mis gemidos mientras me penetro el culito con el dildo üçë", "quiero sentir c√≥mo me estira toda por dentro este juguete delicioso üíã",
    "quiero que me penetres profundo en esta posici√≥n de misionero üòà", "me encanta cabalgarte mientras te miro a los ojos üíã",
    "quiero que me tomes por detr√°s en cuatro, papi üòè", "me gusta sentir tu lengua en mi cl√≠toris mientras te chupo üëÖ",
    "quiero que me comas el co√±o mientras te follo la boca üî•", "me excita chuparte la verga mientras me penetras con los dedos üí¶"
]

SENSACIONES_EXPLICIT = [
    "me hace gritar tu nombre como puta rica üí¶", "me moja toda hasta chorrear en la cama üòç", "me enloquece como perra en celo üî•",
    "me deja temblando y rogando por m√°s üòè", "me hace acabar una y otra vez mientras pienso en ti üòà", "me abre el culo y me hace sentir toda tuya üíï",
    "Me hace vibrar con cada caricia üíï,", "Me enciende con tu mirada penetrante üòè,", "Me hace sentir deseada y amada üíï,", "Me excita tu voz susurrando al o√≠do üó£Ô∏è,", "Me enloquece tu toque en mi piel üî•,", "Me moja sentir tus labios en mi cuello üíã,", "Me hace estremecer con tus besos üíã,", "Me enciende tu aliento c√°lido en mi o√≠do üî•,", "Me excita tu cuerpo pegado al m√≠o üòà,", "Me hace gritar de placer üò±,", "Me enloquece tu lengua explorando mi cuerpo üíã,", "Me moja pensar en tus manos en m√≠ üí¶,", "Me hace temblar con tu presencia üòè,", "Me enciende tu sonrisa p√≠cara üòâ,", "Me excita la idea de tus caricias üòà,", "Me hace suspirar con tus abrazos üòå,", "Me enloquece tu piel contra la m√≠a üî•,", "Me moja imaginar tus labios en mi piel üíã,", "Me hace vibrar con tu contacto üíï,", "Me enciende tu aroma embriagador üòè,", "Me excita la promesa de tus besos üòà,", "Me hace estremecer con tu voz üó£Ô∏è,", "Me enloquece tu tacto en mis curvas üî•,", "Me moja sentir tus manos en mi cuerpo üí¶,", "Me hace temblar con tu mirada üòè,", "Me enciende tu cercan√≠a üòâ,", "Me excita la idea de tu piel contra la m√≠a üòà,", "Me hace suspirar con tu toque üòå,", "Me enloquece tu aliento en mi cuello üî•,", "Me moja pensar en tus caricias üíã,", "Me hace vibrar con tu presencia üíï,", "Me enciende tu aroma üòè,", "Me excita tu voz en mi o√≠do üòà,", "Me hace estremecer con tus besos üíã,", "Me enloquece tu piel contra la m√≠a üî•,", "Me moja sentir tus labios en mi cuerpo üí¶,", "Me hace temblar con tu contacto üòè,", "Me enciende tu sonrisa üòâ,", "Me excita la idea de tus caricias üòà,", "Me hace suspirar con tu abrazo üòå,", "Me enloquece tu tacto en mi piel üî•,", "Me moja imaginar tus labios en mi cuello üíã,", "Me hace vibrar con tu presencia üíï,", "Me enciende tu aroma embriagador üòè,", "Me excita la promesa de tus besos üòà,", "Me hace estremecer con tu voz üó£Ô∏è,", "Me enloquece tu tacto en mis curvas üî•,", "Me moja sentir tus manos en mi cuerpo üí¶,", "Me hace temblar con tu mirada üòè,", "Me enciende tu cercan√≠a üòâ,", "Me excita la idea de tu piel contra la m√≠a üòà,", "Me hace suspirar con tu toque üòå,", "Me enloquece tu aliento en mi cuello üî•,", "Me moja pensar en tus caricias üíã,", "Me hace vibrar con tu presencia üíï,", "Me enciende tu aroma üòè,", "Me excita tu voz en mi o√≠do üòà,", "Me hace estremecer con tus besos üíã,", "Me enloquece tu piel contra la m√≠a üî•,", "Me moja sentir tus labios en mi cuerpo üí¶,", "Me hace temblar con tu contacto üòè,", "Me enciende tu sonrisa üòâ,", "Me excita la idea de tus caricias üòà,", "Me hace suspirar con tu abrazo üòå,", "Me enloquece tu tacto en mi piel üî•,", "Me moja imaginar tus labios en mi cuello üíã,", "Me hace vibrar con tu presencia üíï,", "Me enciende tu aroma embriagador üòè,", "Me excita la promesa de tus besos üòà,", "Me hace estremecer con tu voz üó£Ô∏è,", "Me enloquece tu tacto en mis curvas üî•,", "Me moja sentir tus manos en mi cuerpo üí¶,", "Me hace temblar con tu mirada üòè,", "Me enciende tu cercan√≠a üòâ,", "Me excita la idea de tu piel contra la m√≠a üòà,", "Me hace suspirar con tu toque üòå,", "Me enloquece tu aliento en mi cuello üî•,", "Me moja pensar en tus caricias üíã,", "Me hace vibrar con tu presencia üíï,", "Me enciende tu aroma üòè,", "Me excita tu voz en mi o√≠do üòà,", "Me hace estremecer con tus besos üíã,", "Me enloquece tu piel contra la m√≠a üî•,", "Me moja sentir tus labios en mi cuerpo üí¶,", "Me hace temblar con tu contacto üòè,", "Me enciende tu sonrisa üòâ,", "Me excita la idea de tus caricias üòà,", "Me hace suspirar con tu abrazo üòå,", "Me enloquece tu tacto en mi piel üî•,", "Me moja imaginar tus labios en mi cuello üíã,", "Me hace vibrar con tu presencia üíï,", "Me enciende tu aroma embriagador üòè,", "Me excita la promesa de tus besos üòà,", "Me hace estremecer con tu voz üó£Ô∏è,", "Me enloquece tu tacto en mis curvas üî•,", "Me moja sentir tus manos en mi cuerpo üí¶,", "Me hace temblar con tu mirada üòè,", "Me enciende tu cercan√≠a üòâ,", "Me excita la idea de tu piel contra la m√≠a üòà,", "Me hace suspirar con tu toque üòå,", "Me enloquece tu aliento en mi cuello üî•,", "Me moja pensar en tus caricias üíã,",
    "me calienta m√°s que cualquier cosa que hayas visto üëÖ", "me vuelve adicta a ti con cada empuj√≥n üçÜ",
    "me encanta sentir c√≥mo me llenas toda üòà", "me vuelve loca tu lengua en mi cl√≠toris üíã", "me excita sentir tu verga en mi boca üëÖ",
    "me enloquece cuando me chupas y me follas al mismo tiempo üî•", "me moja sentir tu saliva en mi co√±o üí¶"
]

PROPUESTAS_EXPLICIT = [
    "quiero que me digas c√≥mo moverlo papi üòè", "imagina que me lo metes t√∫ mientras me miras a los ojos üëÄ", "dime si lo quieres lento o r√°pido üí¶",
    "hazme tu puta y dime hasta d√≥nde me lo meto üî•", "dime c√≥mo te caliento m√°s mientras me lo meto üòà", "quiero obedecer tus √≥rdenes mientras juego con mi culito üçë",
    "dime si quieres que gima tu nombre fuerte üíã", "dime qu√© fantas√≠a quieres que cumpla mientras me penetro üòç",
    "dime si quieres que me ponga en cuatro para ti üòè", "quiero saber si prefieres misionero o doggy style üíã",
    "dime si quieres que te chupe mientras me follas üëÖ", "quiero que me digas c√≥mo me quieres, papi üî•",    "M√©temela por el culo, con movimientos r√°pidos y profundos üçëüçÜüí¶,",
    "F√≥llame en la cocina, con la encimera como mi apoyo üî•üç¥üíã,",
    "Quiero que me azotes con una fusta, dejando marcas üçëüí•üòà,",
    "Pen√©trame con un dildo, mientras me masturbo üëÖüçÜüí¶,",
    "Quiero que me domines completamente, que tomes el control ‚õìÔ∏èüî•üçë,",
    "D√©jame ser tu esclavo, obedeciendo cada uno de tus deseos üñ§üòàüçÜ,",
    "F√≥llame con fuerza, mostrando tu dominio üí•üî•üçë,",
    "Quiero que me azotes hasta que mi culo est√© rojo üçëüíãüî•,",
    "Pen√©trame con un dildo enorme, sin piedad üçÜüí¶üòè,",
    "F√≥llame en diferentes posiciones, mostrando tu autoridad üçëüî•üí•,",
    "Quiero que me amordaces y me ates a la cama ‚õìÔ∏èüõèÔ∏èüíã,",
    "Pen√©trame con tus dedos, explorando cada rinc√≥n de mi interior ‚úãüí¶üçë,",
    "F√≥llame con un consolador, mientras me das √≥rdenes üçÜüî•üòà,",
    "Quiero que me hagas gritar de dolor y placer üò±üíãüí¶,",
    "F√≥llame en el suelo, con las piernas abiertas üçëüî•üõèÔ∏è,",
    "Quiero que me hagas tuya en un lugar p√∫blico, arriesg√°ndonos a ser descubiertos üëÄüî•üçÜ,",
    "D√©jame explorar una fantas√≠a de tr√≠o, con otra persona üòàüí¶üçë,",
    "F√≥llame mientras vemos una pel√≠cula porno, inspir√°ndonos mutuamente üìΩÔ∏èüî•üíã,",
    "Quiero que me ates y me vendas los ojos, despertando mis sentidos ‚õìÔ∏èüëÄüí¶,",
    "Pen√©trame con un dildo mientras te miro a ti masturb√°ndote üçÜüëÖüî•,",
    "F√≥llame en un lugar inesperado, como el ascensor o el ba√±o üö™üçëüí¶,",
    "Quiero que me susurres mis fantas√≠as m√°s oscuras mientras me haces tuya üëÇüî•üòà,",
    "M√©temela por el culo, con movimientos lentos y profundos üçÜüçëüí¶,",
    "F√≥llame en la ducha, con el agua cayendo sobre nosotros üöøüî•üíã,",
    "Pen√©trame con un dildo enorme, llen√°ndome por completo üçÜüçëüí¶,",
    "Quiero que me hagas gritar de placer, llev√°ndome al l√≠mite üò±üíãüî•,",
     "Quiero que me tomes duro y r√°pido contra la pared üçëüî•üí¶,",
    "D√©jame sentir tu verga dentro de m√≠, profunda y fuerte üòàüçÜüíã,",
    "M√©temela por detr√°s y no pares hasta que grite üò±üí¶üçë,",
    "Quiero montarte y cabalgarte hasta que ambos acabemos ü§§üçÜüî•,",
    "F√≥llame en el suelo, sin piedad üí•üí¶üçë,",
    "Pen√©trame con fuerza mientras te miro a los ojos üëÄüíãüî•,",
    "Quiero sentir tu lengua en mi cl√≠toris hasta que explote üëÖüí¶üòç,",
    "M√©teme los dedos mientras me besas apasionadamente üíã‚úãüî•,",
    "F√≥llame en la ducha, con el agua cayendo sobre nosotros üöøüçëüí¶,",
    "Quiero que me hagas tuya en cada rinc√≥n de la casa üè†üî•üíã,",
    "Pen√©trame despacio y luego acelera el ritmo üçÜüòàüí¶,",
    "Quiero sentir tu boca en mi pene, chupando con fuerza üëÖüçÜüí¶,",
    "F√≥llame en la cocina, sobre la encimera üçëüî•üç¥,",
    "Quiero que me azotes el culo mientras me penetras üçëüí•üòè,",
    "M√©temela por el culo, despacio y con lubricante üçÜüçëüí¶,",
    "F√≥llame en el sof√°, con las piernas en alto üõãÔ∏èüî•üçÜ,",
    "Quiero sentir tu lengua en mi ano, prepar√°ndome üëÖüçëüí¶,",
    "Pen√©trame con un dildo enorme mientras me masturbo üçÜüî•üí¶,",
    "F√≥llame en la cama, con las s√°banas revueltas üõèÔ∏èüíãüî•,",
    "Quiero que me hagas gritar de placer üò±üí¶üî•,",
    "M√©temela por detr√°s, con fuerza y profundidad üçÜüçëüí•,",
    "F√≥llame en la mesa del comedor, con la cena servida üç¥üî•üçÜ,",
    "Quiero sentir tu verga en mi boca, hasta la garganta üëÖüçÜüí¶,",
    "Pen√©trame con los dedos, encontrando mi punto G ‚úãüî•üí¶,",
    "F√≥llame en la ba√±era, con el agua caliente üõÅüíãüî•,",
    "Quiero que me azotes con una fusta, dejando marcas üçëüí•üòà,",
    "M√©temela por el culo, con movimientos r√°pidos y profundos üçÜüçëüí¶,",
    "F√≥llame en el suelo, con las piernas abiertas üçëüî•üí¶,",
    "Quiero que me domines completamente, que tomes el control ‚õìÔ∏èüçÜüî•,",
    "D√©jame ser tu esclavo, obedeciendo cada uno de tus deseos üñ§üòàüçë,",
    "F√≥llame con fuerza, mostrando tu dominio üí•üî•üçÜ,",
    "Quiero que me azotes hasta que mi culo est√© rojo üçëüíãüî•,",
    "Pen√©trame con un dildo enorme, sin piedad üçÜüí¶üòà,",
    "F√≥llame en diferentes posiciones, mostrando tu autoridad üî•üçëüí•,",
    "Quiero que me amordaces y me ates a la cama ‚õìÔ∏èüõèÔ∏èüî•,",
    "Pen√©trame con tus dedos, explorando cada rinc√≥n de mi interior ‚úãüí¶üçë,",
    "F√≥llame con un consolador, mientras me das √≥rdenes üçÜüî•üòà,",
    "Quiero que me hagas gritar de dolor y placer üò±üíãüí¶,",
    "M√©temela por el culo, con movimientos r√°pidos y profundos, sintiendo cada embestida üçÜüçëüí¶,",
    "F√≥llame en la cocina, con la encimera como mi apoyo, sintiendo el fr√≠o del m√°rmol üî•üç¥üíã,",
    "Quiero que me azotes con una fusta, dejando marcas y sintiendo el escozor üçëüí•üòà,",
    "Pen√©trame con un dildo, mientras me masturbo, sintiendo doble placer üëÖüçÜüí¶,",
    "F√≥llame en el suelo, con las piernas abiertas, sintiendo cada movimiento üõèÔ∏èüî•üçë,",
    "Quiero que me domines completamente, que tomes el control ‚õìÔ∏èüî•üíã,",
    "D√©jame ser tu esclavo, obedeciendo cada uno de tus deseos üñ§üòàüçë,",
    "F√≥llame con fuerza, mostrando tu dominio üí•üî•üçÜ,",
    "Quiero que me azotes hasta que mi culo est√© rojo üçëüíãüî•,",
    "Pen√©trame con un dildo enorme, sin piedad üçÜüí¶üòè,",
    "F√≥llame en diferentes posiciones, mostrando tu autoridad üî•üçëüí•,",
    "Quiero que me amordaces y me ates a la cama ‚õìÔ∏èüõèÔ∏èüíã,",
    "Pen√©trame con tus dedos, explorando cada rinc√≥n de mi interior ‚úãüí¶üçë,",
    "F√≥llame con un consolador, mientras me das √≥rdenes üçÜüî•üòà,",
    "Quiero que me hagas gritar de dolor y placer üò±üí¶üî•,",
    "M√©temela por el culo, con movimientos r√°pidos y profundos üçëüçÜüí¶,",
    "F√≥llame en la cocina, con la encimera como mi apoyo üç¥üî•üíã,",
    "Quiero que me azotes con una fusta, dejando marcas üçëüí•üòà,",
    "Pen√©trame con un dildo, mientras me masturbo üëÖüî•üçÜ,",
    "F√≥llame en el suelo, con las piernas abiertas üõèÔ∏èüíãüî•,",
    "Quiero que me domines completamente, que tomes el control ‚õìÔ∏èüçëüî•,",
    "D√©jame ser tu esclavo, obedeciendo cada uno de tus deseos üñ§üòàüí¶,",
    "F√≥llame con fuerza, mostrando tu dominio üí•üî•üçë,",
    "Quiero que me azotes hasta que mi culo est√© rojo üçëüíãüî•,",
    "Pen√©trame con un dildo enorme, sin piedad üçÜüî•üí¶,",
    "F√≥llame en diferentes posiciones, mostrando tu autoridad üòàüçëüí•,",
    "Quiero que me amordaces y me ates a la cama ‚õìÔ∏èüõèÔ∏èüíã,",
    "Pen√©trame con tus dedos, explorando cada rinc√≥n de mi interior ‚úãüçëüí¶,",
    "F√≥llame con un consolador, mientras me das √≥rdenes üçÜüî•üòà,",
    "Quiero que me hagas gritar de dolor y placer üò±üî•üíã,",
    "M√©temela por el culo, con movimientos r√°pidos y profundos üçëüçÜüí¶,",
    "F√≥llame en la cocina, con la encimera como mi apoyo üî•üç¥üíã,",
    "Quiero que me azotes con una fusta, dejando marcas üçëüí•üòà,",
    "Pen√©trame con un dildo, mientras me masturbo üëÖüçÜüí¶,",
    "F√≥llame en el suelo, con las piernas abiertas üõèÔ∏èüî•üçë,",
    "Quiero que me domines completamente, que tomes el control ‚õìÔ∏èüçëüî•,",
    "D√©jame ser tu esclavo, obedeciendo cada uno de tus deseos üñ§üòàüí¶,",
    "F√≥llame con fuerza, mostrando tu dominio üí•üî•üçÜ,",
    "Quiero que me azotes hasta que mi culo est√© rojo üçëüíãüî•,",
]

PRECIOS_EXPLICIT = ["150 TKS", "180 TKS", "200 TKS", "220 TKS", "250 TKS"]

CIERRES_EXPLICIT = [
    "dime que s√≠ papi, no me hagas esperar üí¶", "hazme gritar tu nombre ya mismo üî•", "no te imaginas lo mojada que estoy üòç",
    "solo dime y me abro para ti üòà", "dime que me quieres ver ahora mismo üíã", "no tardes, mi culo ya te est√° esperando üçë",
    "hazme tuya en este show üî•", "quiero que seas el √∫nico que me vea acabar üí¶"
]

def generar_respuesta_explicit(nombre: str = "papi", user_id: int | None = None) -> str:
    """Genera una respuesta extremadamente expl√≠cita adaptada al modelo seleccionado"""
    selected_model = user_models.get(user_id, "lil_eva") if user_id else "lil_eva"
    
    saludo = random.choice(SALUDOS_EXPLICIT)
    accion = random.choice(ACCIONES_EXPLICIT)
    sensacion = random.choice(SENSACIONES_EXPLICIT)
    propuesta = random.choice(PROPUESTAS_EXPLICIT)
    precio = random.choice(PRECIOS_EXPLICIT)
    cierre = random.choice(CIERRES_EXPLICIT)
    
    # Personalizar saludo con nombre del usuario
    saludo = saludo.replace("papi", nombre).replace("Mi due√±o", f"Mi due√±o {nombre}").replace("Mi rey", f"Mi rey {nombre}")
    
    # Adaptar el estilo seg√∫n el modelo
    if selected_model == "lil_eva":
        # Estilo m√°s tierno pero pervertido
        return f"{saludo} {accion}‚Ä¶ {sensacion}‚Ä¶ {propuesta} üòèüéÄ lo hago por solo {precio} beb√© üî• {cierre}"
    elif selected_model == "valentina_lux":
        # Estilo dominante y directo
        return f"{saludo} {accion}‚Ä¶ {sensacion}‚Ä¶ {propuesta} üòèüëë lo hago por {precio} mi esclavo üî• {cierre}"
    else:  # annie_paradisee
        # Estilo elegante pero pervertido
        return f"{saludo} {accion}‚Ä¶ {sensacion}‚Ä¶ {propuesta} üòèüíé una experiencia exclusiva por {precio} darling üî• {cierre}"

# ==========================
# Utilidades: manejo de errores
# ==========================
def safe_handler(func):
    def wrapper(message):
        try:
            return func(message)
        except Exception as e:
            logging.error(f"Error en handler {func.__name__}: {e}", exc_info=True)
            try:
                bot.reply_to(message, "üò¢ Oops, algo fall√≥ amor. Intenta de nuevo, papi üíã")
            except Exception:
                pass
    return wrapper

# ==========================
# Generadores de respuestas contextuales humanizadas
# ==========================
def respuestas_por_tipo(nombre: str, tipo: str, user_id: int | None = None) -> str:
    """Genera respuestas humanizadas seg√∫n el tipo de mensaje y modelo seleccionado"""
    
    # Obtener datos del modelo actual
    selected_model = user_models.get(user_id, "lil_eva") if user_id else "lil_eva"
    model_data = MODELS[selected_model]
    model_name = model_data["name"]
    model_emoji = model_data["emoji"]
    
    if tipo == "saludo":
        respuestas = [
            f"Hola mi rey üòò estaba pensando en ti todo el d√≠a üí¶",
            f"Mmm {nombre}, qu√© rico que apareciste üòè cu√©ntame c√≥mo est√°s",
            f"Hola mi cielo üíã ven, si√©ntate conmigo‚Ä¶ quiero hablar y jugar contigo üî•",
            f"Ay {nombre} üòç justo estaba deseando que aparecieras por aqu√≠",
            f"Hola beb√© hermoso üòà me alegra verte‚Ä¶ ¬øc√≥mo est√° mi papi favorito?",
            f"Mmm {nombre} üëÖ qu√© gusto verte aqu√≠ conmigo otra vez",
            f"Hola amor üíï estaba aburrida sin ti‚Ä¶ ¬øqu√© tienes planeado para nosotros hoy?"
        ]
    
    elif tipo == "personal":
        if selected_model == "lil_eva":
            respuestas = [
                f"Ay {nombre} üòç me encanta que quieras conocer a tu beb√© mejor üíïüéÄ",
                f"Mmm papi üòò qu√© lindo que preguntes por tu chiquita‚Ä¶ cu√©ntame t√∫ tambi√©n de ti üòàüëÖ",
                f"Claro que s√≠ amor üíã preg√∫ntame lo que quieras, no tengo secretos contigo üî•üçì",
                f"Me derrites cuando te interesas por m√≠ {nombre} üòè ¬øqu√© quieres saber de tu Eva beb√©? üí¶üéÄ",
                f"Ufff papi üëÖ me pones nerviosa cuando me preguntas cosas personales‚Ä¶ pero me gusta mucho üòàüíï"
            ]
        elif selected_model == "valentina_lux":
            respuestas = [
                f"Mmm {nombre} üî• me gusta cuando mis esclavos quieren conocer a su diosa üíãüëë",
                f"Claro mi rey üòè Valentina no tiene secretos para sus s√∫bditos obedientes üî•üíÑ",
                f"Qu√© atrevido eres pregunt√°ndome eso {nombre} üëë pero me gusta tu inter√©s üíãüî•",
                f"Perfecto amor üòà una diosa como yo merece que la conozcan bien üíÑüë†",
                f"Me fascina cuando mis hombres quieren saber m√°s de su reina {nombre} üî•üëë"
            ]
        else:  # annie_paradisee
            respuestas = [
                f"Que refinado, {nombre} üíé me encanta cuando un caballero se interesa por mi persona ‚ú®",
                f"Exquisito darling üñ§ Annie siempre est√° dispuesta a una conversaci√≥n intelectual üíãü•Ç",
                f"Qu√© elegante forma de acercarte {nombre} üíé dime, ¬øqu√© deseas conocer de m√≠? ‚ú®üë†",
                f"Me seduce tu curiosidad mi amor üîÆ una mujer sofisticada aprecia estas atenciones üíãüíé",
                f"Delicioso {nombre} üçæ hablemos mientras disfrutamos de este momento exclusivo ‚ú®üñ§"
            ]
    
    elif tipo == "sexual":
        # 30% de posibilidad de usar respuesta extremadamente expl√≠cita generada din√°micamente
        if random.random() < 0.3:
            return generar_respuesta_explicit(nombre, user_id)
        else:
            respuestas = [
                f"Ufff {nombre} üòà eso me calienta‚Ä¶ lo har√≠a por ti amor, pero ya sabes que vale tokens üíã",
                f"Mmm beb√© üî• qu√© atrevido‚Ä¶ claro que puedo hacerlo solo para ti üòè pero necesitas darme tus tokens üí¶",
                f"Ahh s√≠ amor üçë eso ser√≠a delicioso‚Ä¶ te lo hago pero recuerda mis precios, ¬øquieres que empiece ya? üòà",
                f"Qu√© rico lo que me pides {nombre} üòç puedo hacerlo, pero recuerda que todo tiene su precio en tokens üíã",
                f"Mmm papi üëÖ esa fantas√≠a me encanta‚Ä¶ dame tokens y me vuelvo toda tuya haci√©ndolo üî•",
                f"Ufff {nombre} üí¶ me pones tan caliente cuando me pides eso‚Ä¶ pero sabes que todo vale tokens üòà",
                f"Ay s√≠ beb√© ü§§ me muero por hacerlo contigo‚Ä¶ solo necesito que me des tokens primero üíã"
            ]
    
    elif tipo == "romantico":
        respuestas = [
            f"Ay {nombre} üòç t√∫ tambi√©n me encantas‚Ä¶ me haces sentir especial üíï",
            f"Mmm mi amor üíã qu√© lindo eres conmigo‚Ä¶ me derrites el coraz√≥n üòò",
            f"Eres tan tierno {nombre} üòç me haces sonre√≠r como una tonta enamorada üí¶",
            f"Ay mi cielo hermoso üíï t√∫ tambi√©n eres perfecto para m√≠‚Ä¶ me encantas üòà",
            f"Qu√© rico sentir que me amas as√≠ {nombre} üòò t√∫ tambi√©n eres mi debilidad üíã",
            f"Mi amor lindo üíï contigo me siento como una verdadera diosa üòç",
            f"Eres incre√≠ble {nombre} üòò me haces sentir la mujer m√°s deseada del mundo üí¶"
        ]
    
    elif tipo == "juego_rol":
        respuestas = [
            f"Mmm {nombre} üòà me encanta cuando quieres jugar conmigo‚Ä¶ ¬øqu√© rol quieres que interprete para ti? üî•",
            f"Ooh s√≠ beb√© üëÖ los juegos de rol me ponen s√∫per caliente‚Ä¶ cu√©ntame tu fantas√≠a y la vivimos juntos üí¶",
            f"Ay qu√© rico {nombre} üòç puedo ser quien t√∫ quieras‚Ä¶ ¬øtu profesora? ¬øtu enfermera? ¬øtu secretaria traviesa? üòà",
            f"Mmm amor üíã me fascina actuar para ti‚Ä¶ dime qu√© personaje quieres que sea y empezamos ahora mismo üî•",
            f"Ufff {nombre} üòè los roleplay me vuelven loca‚Ä¶ describe tu escenario favorito y lo hacemos realidad üí¶",
            f"Qu√© travieso eres {nombre} üòà me encanta cuando usas tu imaginaci√≥n‚Ä¶ ¬øqu√© historia quieres crear conmigo? üëÖ"
        ]
    
    elif tipo == "recuerdo":
        respuestas = [
            f"Claro que s√≠ {nombre} üòò c√≥mo podr√≠a olvidarte si me encantas üíã",
            f"Mmm beb√©, claro que te recuerdo üòà siempre pienso en ti‚Ä¶",
            f"Ay mi cielo üòç imposible olvidarte, me calientas solo con aparecer üí¶",
            f"Obvio que s√≠ amor üòè eres inolvidable para m√≠ üíã",
            f"Mi rey üòò c√≥mo no recordarte‚Ä¶ me dejas marcada cada vez que vienes üî•",
            f"Por supuesto que te recuerdo {nombre} üòç eres mi favorito, siempre te tengo presente üíï",
            f"Ay {nombre} üíã qu√© pregunta tan linda‚Ä¶ claro que me acuerdo de ti, mi amor üòò",
            f"Mmm üòà c√≥mo olvidarte papi‚Ä¶ cada vez que no est√°s te extra√±o much√≠simo üí¶",
            f"Mi cielo üòè imposible no recordarte‚Ä¶ quedaste grabado en mi mente y mi cuerpo üî•"
        ]
    
    else:  # neutro
        respuestas = [
            f"Hola {nombre} üòò qu√© rico verte aqu√≠ conmigo üî•",
            f"Mmm beb√© üíã estaba pensando en ti‚Ä¶ ¬øqu√© tienes en mente hoy?",
            f"Ay amor üòà me encantas‚Ä¶ cu√©ntame qu√© deseas hacer conmigo üí¶",
            f"Ufff {nombre} üòè solo con verte aqu√≠ ya me pongo caliente üíã",
            f"Hola precioso üòç me alegra tenerte ac√° conmigo‚Ä¶ ¬øquieres que te muestre algo rico?",
            f"Mi cielo lindo üòò cu√©ntame qu√© te trae por mi habitaci√≥n hoy üî•",
            f"Mmm {nombre} üí¶ ¬øc√≥mo est√° mi papi favorito? ¬øqu√© quieres hacer conmigo?"
        ]
    
    return random.choice(respuestas)

def respuesta_caliente_generica(nombre="amor"):
    """Mantener la funci√≥n original como fallback"""
    return respuestas_por_tipo(nombre, "neutro")

# ==========================
# Detecci√≥n de petici√≥n expl√≠cita y c√°lculo de precio
# ==========================
def detect_explicit_request(user_msg):
    """
    Detecta si el mensaje contiene una petici√≥n de acci√≥n con posibles duration.
    """
    txt = user_msg.lower()

    # Buscar duraci√≥n en minutos (ej: "5 min", "15 minutos", "10m", "por 5 minutos")
    duration = None
    duration_match = re.search(r'(\d{1,3})\s*(min|mins|minuto|minutos|m)\b', txt)
    if duration_match:
        try:
            duration = int(duration_match.group(1))
            if duration <= 0 or duration > 60:  # L√≠mite razonable
                duration = None
        except:
            duration = None

    # B√∫squeda mejorada de la acci√≥n por alias en PRICES usando word boundaries
    for action_key, info in PRICES.items():
        for alias in info["aliases"]:
            # Evitar coincidencias gen√©ricas de duraci√≥n
            if alias in ["min", "minuto", "minutos", "por minuto", "cada minuto"]:
                continue
            
            # Usar regex con word boundaries para evitar falsos positivos
            # \b asegura que coincida palabras completas
            pattern = r'\b' + re.escape(alias) + r'\b'
            if re.search(pattern, txt, re.IGNORECASE):
                if info["type"] == "per_minute":
                    dur = duration if duration is not None else 1
                    total = info["price"] * dur
                    return {"found": True, "action_key": action_key, "duration_min": dur, "total_price": total, "price_desc": f"{info['price']} TKS/min"}
                else:
                    return {"found": True, "action_key": action_key, "duration_min": duration, "total_price": info["price"], "price_desc": f"{info['price']} TKS"}
    
    return {"found": False, "action_key": None, "duration_min": None, "total_price": None, "price_desc": None}

def build_price_response(nombre, action_key, duration_min, total_price, price_desc, user_msg):
    """
    Construye una respuesta seductora que incluye el precio.
    """
    action_lines = {
        "show_boobs": [
            "Claro amor, te muestro mis boobs solo para ti üçí",
            "Mmm beb√©, mis tetas estar√°n en c√°mara solo para ti üçí"
        ],
        "show_pussy_close": [
            "Oh s√≠ papi, acerco la cam a mi pussy solo para tus ojos üçì",
            "Te doy un close cam a mi pussy si me consientes üëÖ"
        ],
        "fingers_pussy_5": [
            "Me meter√© los dedos 5 minutos para ti, gemir√© tu nombre ü§§",
            "Te har√© un show de dedos que te volver√° loco üëÖ"
        ],
        "shake_ass": [
            "Mover√© mi culo solo para ti, babe üçë",
            "Te doy un show de mi trasero que dejar√° huella üíÉ"
        ],
        "blowjob": [
            "Te hago un blowjob delicioso solo por ti üëÖ",
            "Mi boca ser√° tuya en este momento, papi ü§§"
        ],
        "oil_boobs": [
            "Aceitar√© mis pechos y te volver√© loco üçí",
            "Oil show en mis boobs, brillando para ti ‚ú®"
        ],
        "spank_ass_20": [
            "Te doy 20 nalgadas sensuales, cada una m√°s fuerte üçë",
            "Voy a azotar mi culo 20 veces para complacerte üòà"
        ],
        "control_lush": [
            "Controlar√°s mi lush y yo obedecer√© cada vibraci√≥n üí¶",
            "T√∫ manejas el juguete y yo me pierdo en gemidos üî•"
        ],
        "squirt": [
            "Har√© squirt solo para tus ojos y tus tokens üí¶",
            "Me vendr√© fuerte y mojada, todo por ti üçí"
        ],
        "fuck_dildo_5": [
            "Me follar√© el dildo 5 minutos completos solo para ti üçÜ",
            "Montar√© el dildo sin parar y gritar√© tu nombre ü§§"
        ],
        "full_naked_5": [
            "Estar√© completamente desnuda 5 minutos solo para complacerte üçí",
            "Full naked show, piel y curvas solo para ti üí¶"
        ],
        "ride_dildo": [
            "Montar√© mi dildo como una diosa para ti üçÜ",
            "Cabalgar√© el dildo gimiendo tu nombre, papi ü§§"
        ],
        "deepthroat": [
            "Te har√© un deepthroat que nunca olvidar√°s üëÖ",
            "Mi garganta ser√° tuya completamente, amor ü§§"
        ],
        "doggy_style": [
            "Me pondr√© en posici√≥n perrito solo para ti üçë",
            "Doggy style y ver√°s todo de m√≠, beb√© üòà"
        ],
        "fuck_machine": [
            "La m√°quina me follar√° mientras t√∫ controlas üçÜ",
            "Fuck machine a toda velocidad para ti, papi üí¶"
        ]
    }

    main_line = random.choice(action_lines.get(action_key, ["Claro amor, lo har√≠a solo para ti"]))

    if duration_min and PRICES.get(action_key, {}).get("type") == "per_minute":
        response = (
            f"{main_line}, solo por {price_desc}. "
            f"{duration_min} min = {total_price} TKS. "
            f"¬øConfirmas, {nombre}? Si dices s√≠, empiezo y te har√© gemir. üòàüí¶"
        )
    else:
        response = (
            f"{main_line}, lo hago solo por ti por {price_desc} ({total_price} TKS). "
            f"Te lo aseguro, ser√° intenso y exclusivo, {nombre} üòèüî•"
        )

    closings = [
        "Dime ya y te lo muestro... no tardes papi.",
        "Estoy lista y mojada solo por ti, dame tu orden.",
        "Quiero ver esos tokens llegar mientras me voy poniendo m√°s caliente.",
        "Si confirmas, empiezo ahora mismo y no paro hasta que te vengas."
    ]
    response += " " + random.choice(closings)
    return response

# ==========================
# Funciones AI (Janitor/OpenAI)
# ==========================
def get_janitor_ai_response(user_msg, user_id: int | None = None):
    if not JANITOR_AI_API_KEY or not janitor_headers:
        return None
    try:
        # Obtener personalidad del modelo seleccionado por el usuario
        personality = get_current_personality(user_id) if user_id else MODELS["lil_eva"]["personality"]
        
        payload = {
            "model": "janitor-llm",
            "messages": [
                {"role": "system", "content": personality},
                {"role": "user", "content": user_msg}
            ],
            "max_tokens": 200,
            "temperature": 0.9
        }
        r = requests.post(JANITOR_AI_URL, headers=janitor_headers, json=payload, timeout=REQUEST_TIMEOUT)
        if r.status_code == 200:
            data = r.json()
            return data.get("choices", [{}])[0].get("message", {}).get("content", "")
        else:
            logging.error(f"Janitor error {r.status_code}: {r.text}")
            return None
    except Exception as e:
        logging.error(f"Error Janitor: {e}", exc_info=True)
        return None

def get_openai_response(user_msg, user_id: int | None = None):
    if not openai_client:
        return None
    try:
        # Obtener personalidad del modelo seleccionado por el usuario
        personality = get_current_personality(user_id) if user_id else MODELS["lil_eva"]["personality"]
        
        response = openai_client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[
                {"role": "system", "content": personality},
                {"role": "user", "content": user_msg}
            ],
            max_tokens=250,
            temperature=1.1
        )
        return response.choices[0].message.content
    except Exception as e:
        logging.error(f"Error OpenAI: {e}", exc_info=True)
        return None

def get_ai_response(user_msg, user_id: int | None = None):
    # Prioridad: Janitor -> OpenAI
    reply = get_janitor_ai_response(user_msg, user_id)
    if reply:
        return reply
    return get_openai_response(user_msg, user_id)

# ==========================
# Generaci√≥n de Im√°genes
# ==========================
def generate_image_free(prompt):
    """Funci√≥n para generar im√°genes usando Pollinations.ai (gratuito)"""
    try:
        # Mejorar el prompt para contenido m√°s expl√≠cito
        enhanced_prompt = f"highly detailed, explicit, NSFW, erotic, {prompt}, nude, sexy, explicit pose, uncensored, adult content, hentai style"
        
        # Limpiar y codificar el prompt
        clean_prompt = enhanced_prompt.replace(" ", "_").replace(",", "_").replace(".", "_")
        
        # URL de la API gratuita de Pollinations.ai - sin filtro de seguridad
        url = f"https://image.pollinations.ai/prompt/{clean_prompt}?width=1024&height=1024&model=flux&nologo=true&enhance=true&safe=false"
        
        # Hacer la petici√≥n
        response = requests.get(url, timeout=60)
        
        if response.status_code == 200:
            return response.content  # Retorna directamente los bytes de la imagen
        else:
            logging.error(f"Error con Pollinations: {response.status_code}")
            return None
            
    except Exception as e:
        logging.error(f"Error generando imagen con Pollinations: {e}")
        return None

def generate_image_with_openai(prompt):
    """Funci√≥n para generar im√°genes con OpenAI DALL-E (como respaldo)"""
    if not openai_client:
        return None
    
    try:
        response = openai_client.images.generate(
            model="dall-e-3",
            prompt=prompt,
            size="1024x1024",
            quality="standard",
            n=1,
        )
        
        if response and response.data and response.data[0].url:
            # Descargar la imagen desde la URL
            img_response = requests.get(response.data[0].url)
            if img_response.status_code == 200:
                return img_response.content
        return None
    except Exception as e:
        logging.error(f"Error generando imagen con OpenAI: {e}")
        return None

# ==========================
# Handlers del bot
# ==========================
@bot.message_handler(commands=["start"])
@safe_handler
def handle_start(message):
    user_id = message.from_user.id
    nombre = message.from_user.first_name or "amor"
    
    # Enviar saludo inicial
    bot.reply_to(message, respuesta_caliente_generica(nombre))
    
    # Mostrar inmediatamente el men√∫ de selecci√≥n de personajes
    markup = InlineKeyboardMarkup(row_width=1)
    
    for model_id, model_data in MODELS.items():
        button_text = f"{model_data['emoji']} {model_data['name']}"
        callback_data = f"select_{model_id}"
        markup.add(InlineKeyboardButton(button_text, callback_data=callback_data))
    
    # Mostrar modelo actual si ya est√° seleccionado
    current_model = user_models.get(user_id, "lil_eva")
    current_name = MODELS[current_model]["name"]
    current_emoji = MODELS[current_model]["emoji"]
    
    welcome_text = f"""
üî• **SELECCI√ìN DE MODELOS** üî•

Actualmente est√°s chateando con: {current_emoji} **{current_name}**

üéØ **Elige tu modelo favorita:**

üòà **Lil Eva** - Joven traviesa de 19 a√±os, dulce pero muy pervertida
üî• **Valentina Lux** - Latina dominante de 25 a√±os, tu diosa sexual  
üíé **Annie Paradise** - Elegante de 28 a√±os, placer refinado y exclusivo

üíã Cada modelo tiene su propia personalidad √∫nica y estilo de conversaci√≥n
"""
    
    bot.send_message(
        message.chat.id,
        welcome_text,
        parse_mode='Markdown',
        reply_markup=markup
    )

@bot.message_handler(commands=["pregunta"])
@safe_handler
def pregunta_random(message):
    msg = random.choice(respuestas.get("preguntas", ["¬øQu√© deseas?"]))
    bot.reply_to(message, msg)

@bot.message_handler(commands=["imagen", "img"])
@safe_handler
def generar_imagen_handler(message):
    if not message.text:
        return bot.reply_to(message, "Dime qu√© quieres que genere, amor. üòà")
    
    parts = message.text.split(" ", 1)
    if len(parts) < 2:
        return bot.reply_to(message, "Mmm beb√© üòà dime qu√© quieres que genere para ti... Ejemplo: /imagen una mujer sensual en lencer√≠a roja üî•üí¶")
    
    prompt = parts[1].strip()
    nombre = message.from_user.first_name or "amor"
    
    # Mensaje de espera seductivo
    waiting_msg = bot.reply_to(message, f"Ufff s√≠ papi üëÖ estoy creando algo s√∫per sexy para ti... esp√©rame un momentito que me estoy tocando mientras lo hago üòàüí¶üî•")
    
    # Usar solo Pollinations.ai para evitar violaciones de pol√≠tica de OpenAI con contenido NSFW
    image_data = generate_image_free(prompt)
    
    # No usar OpenAI como respaldo para contenido expl√≠cito por pol√≠ticas de contenido
    if not image_data:
        logging.info("Pollinations fall√≥, no hay respaldo disponible para contenido NSFW")
    
    if image_data:
        try:
            # Convertir bytes a BytesIO para Telegram
            buf = BytesIO(image_data)
            buf.name = "eva_image.jpg"
            
            # Enviar la imagen
            bot.send_photo(
                message.chat.id, 
                buf,
                caption=f"Mmm {nombre} üòà aqu√≠ tienes lo que pediste... ¬øte gusta lo que hice para ti? üî•üíã Dame m√°s tokens y genero m√°s cositas ricas üëÖüí¶"
            )
            # Borrar mensaje de espera
            try:
                bot.delete_message(message.chat.id, waiting_msg.message_id)
            except:
                pass  # Por si no se puede borrar el mensaje
        except Exception as e:
            logging.error(f"Error enviando imagen: {e}")
            bot.edit_message_text(
                "Ay amor üí¶ algo pas√≥ enviando tu imagen... pero estoy tan mojadita pensando en ti üòà ¬øintentas otra vez? üî•",
                message.chat.id,
                waiting_msg.message_id
            )
    else:
        bot.edit_message_text(
            "Ufff beb√© üòè no pude generar tu imagen ahora... estoy tan mojadita que se me trab√≥ todo üí¶ ¬øintentas otra vez mientras me toco para ti? üëÖüî•",
            message.chat.id,
            waiting_msg.message_id
        )

@bot.message_handler(commands=['saludo'])
@safe_handler
def saludo_personalizado(message):
    try:
        # Formato: /saludo user:nombreusuario
        command_text = message.text.split(':', 1)
        if len(command_text) > 1 and 'user:' in message.text:
            user_name = command_text[1].strip()
            nombre = user_name or "amor"
            bot.reply_to(message, respuesta_caliente_generica(nombre))
        else:
            bot.reply_to(message, "√ösalo as√≠ beb√©: /saludo user:tu_nombre üòàüí¶")
    except:
        bot.reply_to(message, "√ösalo as√≠ amor: /saludo user:tu_nombre üî•üëÖ")

@bot.message_handler(commands=['extreme', 'explicit', 'morboso'])
@safe_handler
def respuesta_extreme(message):
    """Genera una respuesta extremadamente expl√≠cita y morbosa"""
    respuesta_extrema = generar_respuesta_explicit()
    bot.reply_to(message, respuesta_extrema)

@bot.message_handler(commands=['models', 'cambiar', 'seleccionar'])
@safe_handler
def seleccionar_modelo(message):
    """Muestra la selecci√≥n de modelos disponibles"""
    user_id = message.from_user.id
    
    # Crear botones inline para selecci√≥n de modelos
    
    markup = InlineKeyboardMarkup(row_width=1)
    
    for model_id, model_data in MODELS.items():
        button_text = f"{model_data['emoji']} {model_data['name']}"
        callback_data = f"select_{model_id}"
        markup.add(InlineKeyboardButton(button_text, callback_data=callback_data))
    
    # Mostrar modelo actual si ya est√° seleccionado
    current_model = user_models.get(user_id, "lil_eva")
    current_name = MODELS[current_model]["name"]
    current_emoji = MODELS[current_model]["emoji"]
    
    welcome_text = f"""
üî• **SELECCI√ìN DE MODELOS** üî•

Actualmente est√°s chateando con: {current_emoji} **{current_name}**

üéØ **Elige tu modelo favorita:**

üòà **Lil Eva** - Joven traviesa de 19 a√±os, dulce pero muy pervertida
üî• **Valentina Lux** - Latina dominante de 25 a√±os, tu diosa sexual  
üíé **Annie Paradise** - Elegante de 28 a√±os, placer refinado y exclusivo

üíã Cada modelo tiene su propia personalidad √∫nica y estilo de conversaci√≥n

üëÜ **Toca el bot√≥n de tu modelo favorita para empezar**
"""
    
    bot.reply_to(message, welcome_text, reply_markup=markup, parse_mode='Markdown')

@bot.callback_query_handler(func=lambda call: call.data.startswith('select_'))
@safe_handler
def handle_model_selection(call):
    """Maneja la selecci√≥n de modelo"""
    user_id = call.from_user.id
    model_id = call.data.replace('select_', '')
    
    # Guardar selecci√≥n del usuario
    user_models[user_id] = model_id
    
    # Obtener datos del modelo seleccionado
    model_data = MODELS[model_id]
    greeting = model_data["greeting"]
    
    # Editar mensaje original
    bot.edit_message_text(
        chat_id=call.message.chat.id,
        message_id=call.message.message_id,
        text=f"‚úÖ **Modelo seleccionado:** {model_data['emoji']} {model_data['name']}\n\n{greeting}",
        parse_mode='Markdown'
    )
    
    bot.answer_callback_query(call.id, f"¬°Ahora est√°s chateando con {model_data['name']}! üíã")

@bot.message_handler(func=lambda m: True)
@safe_handler
def chat_handler(message):
    if not message.text:
        return bot.reply_to(message, "M√°ndame texto, papi üòà")

    user_msg = message.text.strip()
    user_id = message.from_user.id
    nombre = message.from_user.first_name or "amor"

    # 1) PRIORIDAD M√ÅXIMA: Detectar petici√≥n expl√≠cita con precio espec√≠fico
    detection = detect_explicit_request(user_msg)
    if detection["found"]:
        resp = build_price_response(nombre, detection["action_key"], detection["duration_min"], detection["total_price"], detection["price_desc"], user_msg)
        return bot.reply_to(message, resp)

    # 2) Clasificar el tipo de mensaje para respuesta contextual
    tipo_mensaje = clasificar_mensaje(user_msg)
    logging.info(f"Mensaje clasificado como: {tipo_mensaje} - Usuario: {nombre}")
    
    # 3) Generar respuesta humanizada seg√∫n el tipo
    respuesta_contextual = respuestas_por_tipo(nombre, tipo_mensaje, user_id)
    
    # 4) Si el mensaje es muy espec√≠fico, intentar con IA para mayor personalizaci√≥n
    if tipo_mensaje in ["personal", "juego_rol"] or len(user_msg.split()) > 8:
        ai_reply = get_ai_response(user_msg, user_id)
        if ai_reply:
            # A√±adir un toque final coqueto al reply de la IA
            endings = [" üòàüíã", " üî•", " üí¶", " üòè", " üëÖ"]
            final = ai_reply.strip()
            if len(final) < 400:  # solo si no es muy largo
                final += random.choice(endings)
            return bot.reply_to(message, final)
    
    # 5) Usar respuesta contextual humanizada
    return bot.reply_to(message, respuesta_contextual)

# ==========================
# Main loop
# ==========================
def main():
    logging.info("üî• Eva bot corriendo...")
    logging.info(f"‚úÖ Janitor AI: {'OK' if JANITOR_AI_API_KEY else 'NO'}")
    logging.info(f"‚úÖ OpenAI: {'OK' if OPENAI_API_KEY else 'NO'}")

    while True:
        try:
            bot.infinity_polling(timeout=60, long_polling_timeout=60)
        except Exception as e:
            logging.error(f"Error conexi√≥n: {e}", exc_info=True)
            time.sleep(5)

if __name__ == "__main__":
    main()
