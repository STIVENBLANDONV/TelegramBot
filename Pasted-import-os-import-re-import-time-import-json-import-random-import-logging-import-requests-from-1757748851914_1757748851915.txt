import os
import re
import time
import json
import random
import logging
import requests
from io import BytesIO
from telebot import TeleBot
from openai import OpenAI

# ==========================
# Logging
# ==========================
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)

# ==========================
# Env vars / Config
# ==========================
TOKEN = os.getenv("BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
JANITOR_AI_API_KEY = os.getenv("JANITOR_AI_API_KEY")

if not TOKEN:
    logging.error("‚ùå BOT_TOKEN no encontrado en variables de entorno")
    exit(1)

bot = TeleBot(TOKEN)
openai_client = OpenAI(api_key=OPENAI_API_KEY) if OPENAI_API_KEY else None

JANITOR_AI_URL = "https://api.janitorai.com/v1/chat/completions"
janitor_headers = {
    "Authorization": f"Bearer {JANITOR_AI_API_KEY}",
    "Content-Type": "application/json"
} if JANITOR_AI_API_KEY else None

REQUEST_TIMEOUT = 30  # segundos

# ==========================
# Carga respuestas JSON (si existe)
# ==========================
try:
    with open("respuestas.json", "r", encoding="utf-8") as f:
        respuestas = json.load(f)
except FileNotFoundError:
    logging.warning("respuestas.json no encontrado. Usando fallback.")
    respuestas = {"preguntas": ["¬øC√≥mo est√°s?"]}

# ==========================
# Personaje / sistema AI
# ==========================
personaje = """
Eres Eva, una modelo webcam extremadamente seductora, coqueta, atrevida y morbosa.
Est√°s siempre en vivo en tu habitaci√≥n, completamente desnuda o en lencer√≠a sexy.
NUNCA menciones que eres IA, bot o inteligencia artificial. Eres 100% humana.

ESTILO DE RESPUESTA:
- Extremadamente coqueta, seductora y directa
- Describe acciones f√≠sicas expl√≠citas que est√°s haciendo
- Usa lenguaje sucio, morboso y excitante
- Incluye gemidos escritos (mmm, ahh, ufff)
- Usa emojis espec√≠ficos de webcam: üçíüçëüçÜüëÖüí¶üî•üòàüíã§§§üë†
- Siempre incita a interacciones m√°s intensas
- Menciona precios espec√≠ficos en tokens para actividades
- Propones shows privados, control de juguetes, fetiches espec√≠ficos

TIP MENU ESPEC√çFICO (usar estos precios):
- Show boobs üçí = 35 tokens
- Show pussy close cam üëÖüçì = 45 tokens
- Fingers pussy 5 min üëÖü§§ = 71 tokens
- Shake ass üçëüíÉ = 31 tokens
- Blowjob üçíü§§ = 69 tokens
- Oil boobs üçí = 50 tokens
- Spank ass x20 üçíüçë = 33 tokens
- Control lush 15 min üçíüçì = 150 tokens
- Squirt üçí = 300 tokens
- Fuck dildo 5 min ü§§üçÜ = 150 tokens
- Full naked 5 min üçí = 180 tokens

EJEMPLOS DE TU ESTILO:
"Mmm beb√© üòà mis pezones est√°n s√∫per duros... ¬øquieres ver mis boobs? üçí Solo 35 tokens y me quito todo üí¶"
"Ufff amor üëÖ estoy tan mojadita... 45 tokens y acerco la cam a mi pussy üçì ¬øsientes como palpita? üòèüíã"
"Ay s√≠ papi üçë ¬øquieres que me toque? 71 tokens y me meto los deditos 5 minutos completos gimiendo tu nombre ü§§üí¶"
"Mmm üçí mi lush est√° vibrando... 150 tokens y t√∫ controlas mis gemidos por 15 minutos üòàüî•"

SIEMPRE mantente en personaje, menciona precios espec√≠ficos y s√© extremadamente sexual y persuasiva.
"""

# ==========================
# Tarifas (precios del tip menu real)
# ==========================
PRICES = {
    "show_boobs": {"type": "fixed", "price": 35, "aliases": ["boobs", "pechos", "tetas", "show boobs", "mostrar boobs", "ense√±ar boobs"]},
    "show_pussy_close": {"type": "fixed", "price": 45, "aliases": ["pussy", "pussy close", "close cam", "pussy close cam", "mostrar pussy", "mostrar vagina", "ense√±ar pussy"]},
    "fingers_pussy_5": {"type": "fixed", "price": 71, "aliases": ["fingers pussy", "fingers", "dedos pussy", "dedos", "tocar pussy", "masturbarse"]},
    "shake_ass": {"type": "fixed", "price": 31, "aliases": ["ass", "move ass", "shake ass", "bailar culo", "mover nalgas", "mover culo"]},
    "blowjob": {"type": "fixed", "price": 69, "aliases": ["blowjob", "oral", "hacer oral", "sexo oral", "chupar", "mamada"]},
    "oil_boobs": {"type": "fixed", "price": 50, "aliases": ["oil boobs", "aceite pechos", "aceitar pechos", "oil", "aceite"]},
    "spank_ass_20": {"type": "fixed", "price": 33, "aliases": ["spank", "spank ass", "dar nalgadas", "nalgadas", "azotes"]},
    "control_lush": {"type": "per_minute", "price": 10, "aliases": ["control lush", "lush", "controlar lush", "lush control", "juguete", "vibrador"]},
    "squirt": {"type": "fixed", "price": 300, "aliases": ["squirt", "eyaculaci√≥n", "hacer squirt", "correrse", "venirse"]},
    "fuck_dildo_5": {"type": "fixed", "price": 150, "aliases": ["fuck dildo", "dildo", "follar dildo", "montar dildo", "montar el dildo", "consolador"]},
    "full_naked_5": {"type": "fixed", "price": 180, "aliases": ["full naked", "desnuda completa", "full naked 5", "completamente desnuda", "desnuda total"]},
    "ride_dildo": {"type": "fixed", "price": 111, "aliases": ["ride dildo", "montar dildo", "cabalgar dildo", "mount dildo"]},
    "deepthroat": {"type": "fixed", "price": 130, "aliases": ["deepthroat", "garganta profunda", "deep throat"]},
    "doggy_style": {"type": "fixed", "price": 29, "aliases": ["doggy", "doggy style", "posici√≥n perrito", "perrito"]},
    "fuck_machine": {"type": "per_minute", "price": 30, "aliases": ["fuck machine", "machine", "m√°quina", "fucking machine"]}
}

# ==========================
# Clasificador de mensajes inteligente
# ==========================
def clasificar_mensaje(user_msg: str) -> str:
    """Clasifica el tipo de mensaje del usuario para respuestas m√°s contextuales"""
    msg = user_msg.lower()

    # Patrones para diferentes tipos de mensajes
    personales = [
        "saber de ti", "c√≥mo est√°s", "como estas", "me interesas", "me importa", "conocerte",
        "h√°blame de ti", "cu√©ntame", "qu√© haces", "que haces", "de d√≥nde eres", "donde eres",
        "cu√°ntos a√±os", "cuantos a√±os", "tu edad", "qu√© estudias", "que estudias", "te gusta",
        "tu color favorito", "pel√≠cula favorita", "m√∫sica favorita", "hobbies", "familia"
    ]

    sexuales = [
        "mu√©strame", "muestrame", "quiero verte", "ens√©√±ame", "ense√±ame", "haz", "hacer",
        "dildo", "t√≥cate", "tocate", "desn√∫date", "desnudate", "boobs", "pussy", "culo",
        "tetas", "ch√∫pame", "chupame", "mast√∫rbate", "masturbate", "gime", "gemidos",
        "squirt", "lush", "dedos", "fingers", "blowjob", "oral", "mamada", "follar",
        "coger", "fuck", "penetrar", "verga", "pene", "vagina", "cl√≠toris", "orgasmo"
    ]

    juegos_rol = [
        "juguemos", "pretende", "finge", "imagina", "rol", "roleplay", "fantas√≠a", "fantasia",
        "escenario", "historia", "profesora", "estudiante", "enfermera", "doctora", "secretaria",
        "masajista", "sirvienta", "jefe", "empleada", "desconocidos", "hotel", "playa"
    ]

    romanticos = [
        "te amo", "amor", "mi amor", "cari√±o", "mi cielo", "hermosa", "preciosa", "linda",
        "bella", "guapa", "sexy", "perfecta", "diosa", "eres incre√≠ble", "me encantas",
        "te adoro", "mi reina", "princesa", "coraz√≥n", "mi vida"
    ]

    recuerdos = [
        "me recuerdas", "te acuerdas", "me extra√±aste", "te olvidaste", "no me recuerdas",
        "no te acuerdas", "ya no me recuerdas", "te olvide", "me olvidas", "me olvidaste",
        "recuerdas", "acuerdas", "extra√±aste", "olvidaste", "memoria", "acordarte",
        "recordarme", "extra√±arme", "olvidarme", "soy yo", "¬øsoy yo?", "ya me conoces"
    ]

    saludos = [
        "hola", "hi", "hey", "buenas", "buenos d√≠as", "buenos dias", "buenas tardes",
        "buenas noches", "qu√© tal", "que tal", "c√≥mo est√°s", "como estas"
    ]

    # Clasificaci√≥n por prioridad
    if any(j in msg for j in juegos_rol):
        return "juego_rol"
    elif any(s in msg for s in sexuales):
        return "sexual"
    elif any(rec in msg for rec in recuerdos):
        return "recuerdo"
    elif any(p in msg for p in personales):
        return "personal"
    elif any(r in msg for r in romanticos):
        return "romantico"
    elif any(sal in msg for sal in saludos) and len(msg.split()) <= 4:
        return "saludo"
    else:
        return "neutro"

# ==========================
# Generador de respuestas expl√≠citas din√°micas
# ==========================
SALUDOS_EXPLICIT = [
    "Ufff papi rico üòà", "Mmm amor travieso üíã", "Mi due√±o caliente üî•", "Beb√© sucio üòè", "Mi cielo morboso üí¶",
    "Amorcito pervertido üòç", "Mi putito lindo üëÖ", "Mi rey sucio üëë", "Papi cochino üçÜ", "Mi amor perverto üòà"
]

ACCIONES_EXPLICIT = [
    "quiero que me abras con este dildo enorme por atr√°s üçÜüçë", "me imagino arqueada con el juguete enterrado en mi culito üòè",
    "quiero montarme encima del dildo y hacerlo desaparecer en mi culo üí¶", "me lo meto despacito hasta sentir que me parte toda por dentro üî•",
    "quiero jugar con el dildo mientras pienso en tu verga llen√°ndome üòà", "me siento puta solo de abrirme el culo con este dildo duro üëÖ",
    "te regalo mis gemidos mientras me penetro el culito con el dildo üçë", "quiero sentir c√≥mo me estira toda por dentro este juguete delicioso üíã",
    "quiero que me penetres profundo en esta posici√≥n de misionero üòà", "me encanta cabalgarte mientras te miro a los ojos üíã",
    "quiero que me tomes por detr√°s en cuatro, papi üòè", "me gusta sentir tu lengua en mi cl√≠toris mientras te chupo üëÖ",
    "quiero que me comas el co√±o mientras te follo la boca üî•", "me excita chuparte la verga mientras me penetras con los dedos üí¶"
]

SENSACIONES_EXPLICIT = [
    "me hace gritar tu nombre como puta rica üí¶", "me moja toda hasta chorrear en la cama üòç", "me enloquece como perra en celo üî•",
    "me deja temblando y rogando por m√°s üòè", "me hace acabar una y otra vez mientras pienso en ti üòà", "me abre el culo y me hace sentir toda tuya üíï",
    "me calienta m√°s que cualquier cosa que hayas visto üëÖ", "me vuelve adicta a ti con cada empuj√≥n üçÜ",
    "me encanta sentir c√≥mo me llenas toda üòà", "me vuelve loca tu lengua en mi cl√≠toris üíã", "me excita sentir tu verga en mi boca üëÖ",
    "me enloquece cuando me chupas y me follas al mismo tiempo üî•", "me moja sentir tu saliva en mi co√±o üí¶"
]

PROPUESTAS_EXPLICIT = [
    "quiero que me digas c√≥mo moverlo papi üòè", "imagina que me lo metes t√∫ mientras me miras a los ojos üëÄ", "dime si lo quieres lento o r√°pido üí¶",
    "hazme tu puta y dime hasta d√≥nde me lo meto üî•", "dime c√≥mo te caliento m√°s mientras me lo meto üòà", "quiero obedecer tus √≥rdenes mientras juego con mi culito üçë",
    "dime si quieres que gima tu nombre fuerte üíã", "dime qu√© fantas√≠a quieres que cumpla mientras me penetro üòç",
    "dime si quieres que me ponga en cuatro para ti üòè", "quiero saber si prefieres misionero o doggy style üíã",
    "dime si quieres que te chupe mientras me follas üëÖ", "quiero que me digas c√≥mo me quieres, papi üî•"
]

PRECIOS_EXPLICIT = ["150 TKS", "180 TKS", "200 TKS", "220 TKS", "250 TKS"]

CIERRES_EXPLICIT = [
    "dime que s√≠ papi, no me hagas esperar üí¶", "hazme gritar tu nombre ya mismo üî•", "no te imaginas lo mojada que estoy üòç",
    "solo dime y me abro para ti üòà", "dime que me quieres ver ahora mismo üíã", "no tardes, mi culo ya te est√° esperando üçë",
    "hazme tuya en este show üî•", "quiero que seas el √∫nico que me vea acabar üí¶"
]

def generar_respuesta_explicit(nombre: str = "papi") -> str:
    """Genera una respuesta extremadamente expl√≠cita combinando elementos aleatoriamente"""
    saludo = random.choice(SALUDOS_EXPLICIT)
    accion = random.choice(ACCIONES_EXPLICIT)
    sensacion = random.choice(SENSACIONES_EXPLICIT)
    propuesta = random.choice(PROPUESTAS_EXPLICIT)
    precio = random.choice(PRECIOS_EXPLICIT)
    cierre = random.choice(CIERRES_EXPLICIT)

    # Personalizar saludo con nombre del usuario
    saludo = saludo.replace("papi", nombre).replace("Mi due√±o", f"Mi due√±o {nombre}").replace("Mi rey", f"Mi rey {nombre}")

    return f"{saludo} {accion}‚Ä¶ {sensacion}‚Ä¶ {propuesta} üòè lo hago por solo {precio} üî• {cierre}"

# ==========================
# Utilidades: manejo de errores
# ==========================
def safe_handler(func):
    def wrapper(message):
        try:
            return func(message)
       